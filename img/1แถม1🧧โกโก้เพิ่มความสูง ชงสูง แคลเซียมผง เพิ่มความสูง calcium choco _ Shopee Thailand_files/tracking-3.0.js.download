/**
 * Version 3.0
 * Copyright 2019, Priceza.com
 * Date: 1 Oct 2019
 */
var PZ3=PZ3 || {};
PZ3.saveClick = function() {
    try {
        var lscm = window.location.search.match(/[&?]pzlsclickid=([^&]*)/) || window.location.search.match(/[&?]clickid=(r-pspn--[^&]*)/);
        var pzcm = window.location.search.match(/[&?]pzclickid=([^&]*)/) || window.location.search.match(/[&?]clickid=(r-th--[^&]*)/);
        if (window.localStorage) {
            if (lscm && lscm.length > 1 && lscm[1]) {
                window.localStorage.setItem('pz-ls-clickid', lscm[1]);
                PZ3.Cookie.set('pz-ls-clickid', lscm[1], 30);
            }
            if (pzcm && pzcm.length > 1 && pzcm[1]) {
                window.localStorage.setItem('pz-clickid', pzcm[1]);
                PZ3.Cookie.set('pz-clickid', pzcm[1], 30);
            }
        }
    } catch (e) {}
};
PZ3.loadClick = function(key) {
    if (window.localStorage) {
        var clickid = window.localStorage.getItem(key);
        if (clickid) {            
            return clickid;
        }
    }
    return PZ3.Cookie.get(key);
};
PZ3.process = function(data) {
    if (data && data.length) {
        for (var i=0; i<data.length; i++) {
            var dataItem = data[i];
            if (dataItem.type == 'purchase') {
                PZ3.sendConv(dataItem);
            }
        }
    }
};
PZ3.sendConv = function(p) {
    if (p) {
        var pq = PZ3.convParam(p);
        var pcid = PZ3.loadClick('pz-clickid');
        if (pcid) {
            pq += '&clickid=' + encodeURIComponent(pcid);
        }
        PZ3.createFrame('priceza_cframe_th', 'https://www.priceza.com/tracker?' + pq);
        PZ3.createFrame('pspn_cframe', "https://pdn-data.priceza.com/api/tracker/purchase?" + pq);
    }
};
PZ3.convParam = function(p) {
    var c=new Date().getTime();
    var r="c="+c;
    if (typeof p.type !== 'undefined') { r += "&t="+encodeURIComponent(p.type) };
    if (typeof p.merchantId !== 'undefined') { r += "&m="+encodeURIComponent(p.merchantId) };
    if (typeof p.productId !== 'undefined') { r += "&p="+encodeURIComponent(p.productId) };
    if (typeof p.value !== 'undefined') { r += "&v="+encodeURIComponent(p.value) };
    if (typeof p.filter !== 'undefined') { r += "&f="+encodeURIComponent(p.filter) };
    if (typeof p.data !== 'undefined') { r += "&d="+encodeURIComponent(p.data) };
    r += "&u=" + encodeURIComponent(window.location.href);
    return r;
};
PZ3.Cookie = {
    set : function(name, value, days) {
        var cookieVal = value.replace(/[^a-zA-Z0-9-]/, '');

        var expires;
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toGMTString();
        } else {
            expires = "";
        }

        var host = location.hostname;
        if (host.split('.').length === 1) {
            // no "." in a domain - it's localhost or something similar
            document.cookie = name + "=" + cookieVal + expires + "; path=/";
        } else {
            var domainParts = host.split('.');
            domainParts.shift();
            var domain = '.' + domainParts.join('.');

            document.cookie = name + "=" + cookieVal + expires + "; path=/; domain=" + domain;

            // check if cookie was successfuly set to the given domain
            // (otherwise it was a Top-Level Domain)
            if (PZ3.Cookie.get(name) == null || PZ3.Cookie.get(name) != value) {
                // append "." to current domain
                domain = '.' + host;
                document.cookie = name + "=" + cookieVal + expires + "; path=/; domain=" + domain;
            }
        }
    },

    get : function(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1, c.length);
            }

            if (c.indexOf(nameEQ) == 0)
                return c.substring(nameEQ.length, c.length);
        }
        return null;
    },

    erase : function(name) {
        PZ3.Cookie.set(name, '', -1);
    }
};
PZ3.createFrame = function(name, url) {
    var body = document.getElementsByTagName('body')[0];
    var exFrame = document.getElementById(name);
    if (exFrame === null) {
        var frame = document.createElement('iframe');
        frame.setAttribute('id', name);
        frame.setAttribute('name', name);
        frame.setAttribute('style', 'width:0;height:0;border:0;border:none;');
        frame.setAttribute('scrolling', 'no');
        frame.setAttribute('src', url);
        if (body) {
            body.appendChild(frame);
        } else {
            if (window.addEventListener) {
                window.addEventListener('load', function() {
                    document.getElementsByTagName('body')[0].appendChild(frame);
                });
            } else {
                window.attachEvent('onload', function() {
                    document.getElementsByTagName('body')[0].appendChild(frame);
                });
            }
        }
    } else {
        exFrame.setAttribute('src', url);
    }
};
PZ3.isLs = function(mid) {
    return mid == 314 
        || mid == 13
        || mid == 317 
        || mid == 2002
        || mid == 2063
        || mid == 2094
        || mid == 3045
        || mid == 3046
        || mid == 3135 
        || mid == 3170 
        || mid == 3181 
        || mid == 3210 
        || mid == 3300 
        || mid == 5022
        || mid == 5024
        || mid == 5028
        || mid == 5036
        || mid == 7013 
        || mid == 7069 
        || mid == 7077 
        || mid == 7081 
        || mid == 8486 
        || mid == 10003 
        || mid == 10004
        || mid == 10019 
        || mid == 20001 
        || mid == 30013 
        || mid == 30054 
        || mid == 60001 
        || mid == 60015
        || mid == 300086
        || mid == 300127
        || mid == 300205
        || mid == 300215
        || mid == 300241
        || mid == 300252
        || mid == 300392
        || mid == 300400
        || mid == 300425
        || mid == 300476
        || mid == 300490
        || mid == 300491
        || mid == 300601
        || mid == 300604            
        || mid == 300607
        || mid == 300612
        || mid == 300614
        || mid == 300617
        || mid == 300618
        || mid == 300623
        || mid == 300624
        || mid == 300629
        || mid == 300630
        || mid == 300631
        || mid == 300632
        || mid == 300637
        || mid == 300638
        || mid == 300639
        || mid == 300644
        || mid == 300689
};

PZ3.saveClick();
if (window.pzConvData) {
    PZ3.process(window.pzConvData);
} else {
    window.pzConvData = {
        push: function(dataObj) {
            PZ3.process([ dataObj ]);
        }
    }
}
